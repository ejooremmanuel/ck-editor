<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>WYSIWYG Editor Example</title>
    <!-- Load Trumbowyg CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.25.1/ui/trumbowyg.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.27.3/plugins/table/ui/trumbowyg.table.min.css"
      integrity="sha512-qIa+aUEbRGus5acWBO86jFYxOf4l/mfgb30hNmq+bS6rAqQhTRL5NSOmANU/z5RXc3NJ0aCBknZi6YqD0dqoNw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="./index.css" />
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      p:empty:not(:focus)::before {
        content: attr(data-placeholder);
      }

      /* / The Modal (background) / */
      .modal {
        display: none;
        /* / Hidden by default / */
        position: fixed;
        /* / Stay in place / */
        z-index: 1;
        /* / Sit on top / */
        padding-top: 100px;
        /* / Location of the box / */
        left: 0;
        top: 0;
        width: 100%;

        /* / Full width / */
        height: 100%;
        /* / Full height / */
        overflow: hidden;
        /* / Enable scroll if needed / */
        background-color: rgb(0, 0, 0);
        /* / Fallback color / */
        background-color: rgba(0, 0, 0, 0.4);
        /* / Black w/ opacity / */
      }

      /* / Modal Content / */
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 100%;
        height: 100%;
      }

      /* / The Close Button / */
      .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="myModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <span class="close">&times;</span>
        <p>here...</p>
      </div>
    </div>

    <div id="table-modal" class="modal">
      <div class="modal-dialog modal-sm">
        <!-- Modal content -->
      <div class="modal-content">
        <span class="table-close btn-close my-2" onclick="(()=>{
          const table_modal = document.getElementById('table-modal');
          table_modal.style.display ='none'
        })()"></span>
        <form id="table_form">
          <div style="display: flex; flex-direction: column; gap: 1rem">
            <div>
              <label for="formDataTable" class="text-muted">Choose table type</label>
            <select name="" id="formDataTable" class="form-select">
              <option value="data">Data Table</option>
              <option value="presentation">Presentation Table</option>
            </select>
            </div>
            <button class="btn btn-lg btn-success">Done</button>
          </div>
        </form>
      </div>
      </div>

    </div>
    <!-- Add a textarea for the editor content -->
    <div
      id="trumbowyg-demo"
      contenteditable="true"
      placeholder="start typing"
    ></div>
    <!-- Load jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  </body>

    <!-- Load Trumbowyg JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.25.1/trumbowyg.min.js"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.27.3/plugins/allowtagsfrompaste/trumbowyg.allowtagsfrompaste.min.js"
      integrity="sha512-eN5NSu1g2mus/i1826c6tEsNVKsYc+TAs63EVtyFrnEZkdDFYRRCm5OYmuGPe9h3rezLSXJ2nDkT2i/+/TwqJw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.27.3/plugins/cleanpaste/trumbowyg.cleanpaste.min.js"
      integrity="sha512-UInqT8f+K1tkck6llPo0HDxlT/Zxv8t4OGeCuVfsIlXLrnP1ZKDGb+tBsBPMqDW15OcmV8NDfQe9+EaAG4aXeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      const modal = document.getElementById("myModal");
      const span = document.querySelector(".close");
      const table_modal = document.getElementById("table-modal");
      const table_close = document.querySelector(".tableClose");
      const table_form = document.getElementById("table_form");
      const dataTableForm = document.getElementById("formDataTable");

      let tableType = "";
      let tableId = "";

      dataTableForm.onchange = (e) => {
        tableType = e.target.value;
      };

      table_form.onsubmit = (e) => {
        e.preventDefault();
        const activeTable = document.getElementById(tableId);
        activeTable.setAttribute("table-type", tableType);
        (tableType = ""), (tableId = "");
        table_modal.style.display = "none";
      };

      const keydownHandler = ({ key }) => {
        switch (key) {
          case "Escape":
            table_modal.style.display = "none";
            break;
          default:
        }
      };

      window.addEventListener("keydown", keydownHandler);

      // When the user clicks on <span> (x), close the modal
      span.onclick = function () {
        modal.style.display = "none";
        const editor = $("#trumbowyg-demo").trumbowyg("html");
        const newContent = $(
          `<div><multonion-tf style='color:red;'>I am from function</multonion-tf><p data-placeholder="Insert text here..." contenteditable></p></div>`
        );
        $("#trumbowyg-demo").trumbowyg(
          "html",
          editor + newContent.prop("outerHTML")
        );
      };

      //open modal when shift+3 is pressed
      document.addEventListener("keypress", (e) => {
        e.stopPropagation();

        if (e.shiftKey) {
          if (e.code === "Digit3") {
            modal.style.display = "block";
          }
        }
      });

      class MultonionTF extends HTMLElement {
        constructor() {
          super();
          // Add initialization code here
        }

        connectedCallback() {
          // Add initialization code here
          console.log("connectedCallback");
          //   const shadow = this.attachShadow({ mode: "open" });
          // Add code to run when the element is added to the page
        }

        disconnectedCallback() {
          // Add code to run when the element is removed from the page
          console.log("disconnectedCallback");
        }
      }

      customElements.define("multonion-tf", MultonionTF);

      class MultonionDT extends HTMLElement {
        connectedCallback() {
          const table = this.querySelector("table");
          if (table) {
            const id = Math.random().toString(36).substr(2, 9);
            this.setAttribute("id", id);
            console.log(`Element with id '${id}' connected.`);
            tableId = id;
            table_modal.style.display = "block";

            console.log("Table thing:", table);
          } else {
            console.log("No table found");
          }
        }
        disconnectedCallback() {
          const id = this.getAttribute("id");
          console.log(`Element with id '${id}' disconnected.`);
        }
      }

      customElements.define("multonion-dt", MultonionDT);
      //   function appendHelloTag() {
      //     // Get all elements with class 'trumbowyg-editor'
      //     // const elements = document.querySelectorAll(".trumbowyg-textarea");

      //     // Loop through each element and append a <hello> tag
      //     elements.forEach((element) => {
      //       const helloTag = document.createElement("multonion-tf");
      //       element.appendChild(helloTag);
      //     });
      //   }

      // Initialize the editor
      $(document).ready(function () {
        $("#trumbowyg-demo")
          .trumbowyg({
            autogrow: true,
            btns: [
              ["viewHTML"],
              ["undo", "redo"], // Only supported in Blink browsers
              ["formatting"],
              ["strong", "em", "del"],
              ["superscript", "subscript"],
              ["link"],
              ["insertImage"],
              ["justifyLeft", "justifyCenter", "justifyRight", "justifyFull"],
              ["table"],
              ["tableCellBackgroundColor"],
              [("unorderedList", "orderedList")],
              ["horizontalRule"],
              ["tableBorderColor"]["removeformat"],
              ["fullscreen"],
            ],
          })
          .on("tbwchange", function (e) {
            if (e.target.childNodes) {
              [].forEach.call(e.target.childNodes, function (elm) {
                if (elm.nodeName == "TABLE") {
                  const parentNode = document.createElement("multonion-dt");
                  parentNode.appendChild(elm);
                  e.target.appendChild(parentNode);
                  console.log(e.target.childNodes);
                }
              });
            }
          });
        // appendHelloTag();
      });
      //   $(window).on("load", function () {
      //     const editor = $("#trumbowyg-demo").trumbowyg("html");
      //     const newContent = $("<p>I am from function</p>");
      //     $("#trumbowyg-demo").trumbowyg(
      //       "html",
      //       editor + newContent.prop("outerHTML")
      //     );
      //   });
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.27.3/plugins/table/trumbowyg.table.min.js"
      integrity="sha512-StAj4jlQaB7+Ch81cZyms1l21bLyLjjI6YB2m2UP0cVv6ZEKs5egZYhLTNBU96SylBJEqBquyaAUfFhVUrX20Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="./table-plugin.js"></script>
  </body>
</html>
